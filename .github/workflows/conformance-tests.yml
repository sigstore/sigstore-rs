name: Conformance Tests

on:
  push:
    branches:
      - main
      - experiments
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  conformance:
    name: Run Sigstore Conformance Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-conformance-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-conformance-

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Checkout sigstore-conformance
        run: |
          if [ ! -d "sigstore-conformance" ]; then
            echo "Cloning sigstore-conformance..."
            git clone https://github.com/sigstore/sigstore-conformance.git
          else
            echo "sigstore-conformance already exists"
          fi

      - name: Install conformance suite dependencies
        run: |
          cd sigstore-conformance
          pip install -e .
          pip install pytest

      - name: Build conformance test binary
        run: |
          echo "Building conformance test binary..."
          cargo build --manifest-path tests/conformance/Cargo.toml --release
          echo "Binary built at: tests/conformance/target/release/sigstore"
          ls -lh tests/conformance/target/release/sigstore

      - name: Run conformance tests
        id: conformance
        run: |
          chmod +x conformance.sh
          ./conformance.sh 2>&1 | tee conformance-output.txt

          # Extract test results
          if grep -q "passed" conformance-output.txt; then
            PASSED=$(grep -oP '\d+(?= passed)' conformance-output.txt | tail -1)
            FAILED=$(grep -oP '\d+(?= failed)' conformance-output.txt | tail -1 || echo "0")
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
          fi

      - name: Check test results
        if: always()
        run: |
          if [ -f conformance-output.txt ]; then
            echo "=== Conformance Test Summary ==="
            tail -20 conformance-output.txt

            if grep -q "FAILED" conformance-output.txt; then
              echo ""
              echo "‚ùå Some conformance tests failed!"
              echo "=== Failed Tests ==="
              grep "FAILED" conformance-output.txt || true
              exit 1
            else
              echo ""
              echo "‚úÖ All conformance tests passed!"
            fi
          fi

      - name: Upload conformance test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: conformance-test-results
          path: |
            conformance-output.txt
            tests/conformance/target/release/sigstore
          retention-days: 7

      - name: Comment test results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let output = '';

            try {
              output = fs.readFileSync('conformance-output.txt', 'utf8');
            } catch (err) {
              output = 'Failed to read conformance test output';
            }

            // Extract summary
            const lines = output.split('\n');
            const summaryLine = lines.find(l => l.includes('passed'));

            let body = '## üîç Conformance Test Results\n\n';

            if (summaryLine) {
              const passed = summaryLine.match(/(\d+) passed/)?.[1] || '0';
              const failed = summaryLine.match(/(\d+) failed/)?.[1] || '0';

              if (failed === '0') {
                body += `‚úÖ **All ${passed} conformance tests passed!**\n\n`;
              } else {
                body += `‚ùå **${failed} test(s) failed, ${passed} passed**\n\n`;

                // Add failed test details
                const failedTests = lines.filter(l => l.includes('FAILED'));
                if (failedTests.length > 0) {
                  body += '### Failed Tests:\n```\n';
                  body += failedTests.slice(0, 10).join('\n');
                  if (failedTests.length > 10) {
                    body += `\n... and ${failedTests.length - 10} more`;
                  }
                  body += '\n```\n';
                }
              }
            } else {
              body += '‚ö†Ô∏è Could not parse test results\n';
            }

            body += '\n<details>\n<summary>Full output (last 50 lines)</summary>\n\n```\n';
            body += lines.slice(-50).join('\n');
            body += '\n```\n</details>';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Test summary
        if: success()
        run: |
          echo "‚úÖ Conformance Test Summary:"
          echo "  - All conformance tests passed"
          echo "  - Binary: tests/conformance/target/release/sigstore"
          echo "  - Test suite: sigstore-conformance"
