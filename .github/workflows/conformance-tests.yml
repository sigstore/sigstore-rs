name: Conformance Tests

on:
  push:
    branches:
      - main
      - experiments
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  conformance:
    name: Run Sigstore Conformance Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-conformance-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-conformance-

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Checkout sigstore-conformance
        run: |
          if [ ! -d "sigstore-conformance" ]; then
            echo "Cloning sigstore-conformance..."
            git clone https://github.com/sigstore/sigstore-conformance.git
          else
            echo "sigstore-conformance already exists"
          fi

      - name: Build conformance test binary
        run: |
          echo "Building conformance test binary..."
          cargo build --manifest-path tests/conformance/Cargo.toml --release
          echo "Binary built at: tests/conformance/target/release/sigstore"
          ls -lh tests/conformance/target/release/sigstore

      - name: Run conformance tests
        id: conformance
        run: |
          export ENTRYPOINT=$(pwd)/tests/conformance/target/release/sigstore

          cd sigstore-conformance

          echo "Running conformance tests with entrypoint: $ENTRYPOINT"

          $ENTRYPOINT help

          uv run pytest test \
            --entrypoint="$ENTRYPOINT" \
            --skip-signing \
            -v